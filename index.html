<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <title>Defuse Bomb</title>
  <link rel="stylesheet" href="./css/index.css">
</head>

<body>
  <div class="wrap">
    <h1 class="title">Defuse Bomb</h1>
    <div class="card">
      <div class="row">
        <div>Bomb ID: <span id="bombId" class="mono badge"></span></div>
      </div>

      <div class="grid">
        <select id="group">
          <option value="" selected hidden>Group No.</option>
          <option>1</option>
          <option>2</option>
          <option>3</option>
          <option>4</option>
          <option>5</option>
          <option>6</option>
          <option>7</option>
          <option>8</option>
        </select>

        <input id="pass" type="text" placeholder="Enter Password" inputmode="text" autocomplete="off" />
        <p class="hint">‡πÉ‡∏™‡πà Password ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡∏´‡∏£‡∏∑‡∏≠ ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>

        <div style="display: flex;">
          <button id="btn" type="button" aria-label="Defuse">Defuse</button>
          <a id="openProblemUrl" target="_blank" rel="noopener noreferrer" style="margin-left: 0.5rem;">Puzzle</a>
        </div>
      </div>

      <div id="msg" class="msg">Loading‚Ä¶</div>
    </div>
  </div>

  <script>
    /* ====== CONFIG: paste your Apps Script /exec ====== */
    const API_BASE = 'https://script.google.com/macros/s/AKfycbx9ENHOVLrkPJ_vdWsx01Wfu4AhvazkAZBz3IXZjTgojyukYu6xoWONX7edX1BQmc0S/exec';
    /* ================================================== */

    // JSONP helper (bypasses CORS)
    function jsonp(path, params) {
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        const url = API_BASE + '?' + new URLSearchParams({ ...params, action: path, callback: cb }).toString();

        const s = document.createElement('script');
        window[cb] = (data) => { resolve(data); cleanup(); };
        s.onerror = () => { reject(new Error('JSONP load error')); cleanup(); };

        function cleanup() { try { delete window[cb]; } catch (_) { } s.remove(); }
        s.src = url;
        document.body.appendChild(s);
      });
    }

    const qs = new URLSearchParams(location.search);
    const bombId = (qs.get('id') || '').trim();

    const idEl = document.getElementById('bombId');
    const msg = document.getElementById('msg');
    const problemUrl = document.getElementById('openProblemUrl');
    const btn = document.getElementById('btn');
    const pass = document.getElementById('pass');
    const grp = document.getElementById('group');

    idEl.textContent = bombId || '‚Äî';

    function setMsg(text, cls = 'msg') {
      msg.className = 'msg';
      if (cls) msg.classList.add(cls.replace('msg ', '').trim());
      msg.textContent = text;
    }
    function setLockedUI(on) {
      pass.disabled = on;
      grp.disabled = on;
      btn.disabled = on;
    }
    function setProblemUrl(url) {
      problemUrl.href = url;
    }

    async function load() {
      if (!bombId) { setMsg('‚ö†Ô∏è Missing bomb ID in URL.', 'msg err'); setLockedUI(true); return; }
      setMsg('Loading‚Ä¶', 'msg');
      try {
        const data = await jsonp('get', { id: bombId });
        if (!data.ok) { setMsg('‚ö†Ô∏è ' + (data.message || 'Error'), 'msg err'); return; }
        if (!data.found) { setMsg('‚ùì Bomb not found.', 'msg err'); setLockedUI(true); return; }
        if (data.locked) { setLockedUI(true); setMsg('üîí Already defused by Group ' + (data.group || '‚Äî') + '.', 'msg warn'); return; }
        setProblemUrl(data.problemUrl);
        setLockedUI(false); setMsg('Ready.');
      } catch (e) {
        setMsg('‚ö†Ô∏è Network error: ' + e.message, 'msg err');
      }
    }

    async function defuse() {
      const g = (grp.value || '').trim();
      const v = (pass.value || '').trim();
      if (!g) { setMsg('‚ö†Ô∏è Please select a group (1‚Äì8).', 'msg err'); return; }
      if (!v) { setMsg('‚ö†Ô∏è Please enter a password.', 'msg err'); return; }

      setMsg('Checking‚Ä¶', 'msg');
      btn.disabled = true;

      try {
        const res = await jsonp('check', { id: bombId, password: v, group: g });
        setMsg(res.message || (res.ok ? 'OK' : 'Error'), res.ok ? 'msg ok' : 'msg err');
        if (res.locked) setLockedUI(true);
        else btn.disabled = false;
        // optional haptic on iPhone
        if (navigator.vibrate) navigator.vibrate(res.ok ? 20 : [40, 40, 40]);
      } catch (e) {
        setMsg('‚ö†Ô∏è Network error: ' + e.message, 'msg err');
        btn.disabled = false;
      }
    }

    btn.addEventListener('click', defuse);
    pass.addEventListener('keydown', e => { if (e.key === 'Enter') defuse(); });

    load();
  </script>
</body>

</html>