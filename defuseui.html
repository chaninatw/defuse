<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta charset="utf-8" />
  <title>Defuse Bomb</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px;}
    .card{border:1px solid #eee;border-radius:12px;padding:16px;max-width:560px;margin:0 auto;}
    .grid{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;}
    input,select{padding:10px;font-size:16px;border:1px solid #ccc;border-radius:8px;width:100%;}
    button{padding:10px 14px;font-size:16px;border:0;border-radius:8px;background:#2e7d32;color:#fff;cursor:pointer;}
    button[disabled]{opacity:.6;cursor:not-allowed;}
    .muted{color:#666;font-size:12px;margin-top:8px;}
    .ok{color:#2e7d32;}
    .err{color:#c62828;}
    .hdr{text-align:center;font-weight:700;margin-bottom:8px;}
  </style>
</head>
<body>
  <h2 class="hdr">Defuse Bomb</h2>
  <div class="card">
    <div id="info"></div>
    <div class="grid" style="margin-top:12px;">
      <select id="group">
        <option value="" selected hidden>Select group (1–8)</option>
        <option>1</option><option>2</option><option>3</option><option>4</option>
        <option>5</option><option>6</option><option>7</option><option>8</option>
      </select>
      <input id="pass" type="text" placeholder="Enter Password" autofocus />
      <button id="btn" type="button">Defuse</button>
    </div>
    <div id="msg" class="muted"></div>
  </div>

<script>
  // ====== CONFIG: paste your API base here (your Apps Script /exec) ======
  const API_BASE = 'https://script.google.com/macros/s/PASTE_YOUR_DEPLOYMENT_ID/exec';
  // ======================================================================

  const qs = new URLSearchParams(location.search);
  const bombId = (qs.get('id') || '').trim();
  const info = document.getElementById('info');
  const msg = document.getElementById('msg');
  const btn = document.getElementById('btn');
  const passEl = document.getElementById('pass');
  const groupEl = document.getElementById('group');

  info.innerHTML = 'Bomb ID: <b>' + (bombId || '—') + '</b>';
  function setMsg(t, cls='muted'){ msg.className = cls; msg.textContent = t; }
  function setLockedUI(on){ passEl.disabled=on; groupEl.disabled=on; btn.disabled=on; }

  async function api(path, params){
    const url = new URL(API_BASE);
    url.search = new URLSearchParams({ ...params, action: path }).toString();
    const r = await fetch(url, { method: 'GET', cache: 'no-store' });
    return r.json();
  }

  async function load() {
    if (!bombId) { setMsg('⚠️ Missing bomb ID in URL.', 'err'); setLockedUI(true); return; }
    setMsg('Loading…');
    try {
      const data = await api('get', { id: bombId });
      if (!data.ok) { setMsg('⚠️ ' + (data.message || 'Error')); return; }
      if (!data.found) { setMsg('❓ Bomb not found.', 'err'); setLockedUI(true); return; }
      if (data.locked) { setMsg('🔒 Already defused by Group ' + (data.group || '—') + '.', 'err'); setLockedUI(true); return; }
      setMsg(''); setLockedUI(false);
    } catch (e) {
      setMsg('⚠️ Network error: ' + e, 'err');
    }
  }

  async function defuse() {
    const g = (groupEl.value || '').trim();
    const v = (passEl.value || '').trim();
    if (!g) { setMsg('⚠️ Please select a group (1–8).', 'err'); return; }
    if (!v) { setMsg('⚠️ Please enter a password.', 'err'); return; }
    setMsg('Checking…'); btn.disabled = true;
    try {
      const res = await api('check', { id: bombId, password: v, group: g });
      setMsg(res.message || (res.ok ? 'OK' : 'Error'), res.ok ? 'ok' : 'err');
      if (res.locked) setLockedUI(true); else btn.disabled = false;
    } catch (e) {
      setMsg('⚠️ Network error: ' + e, 'err'); btn.disabled = false;
    }
  }

  btn.addEventListener('click', defuse);
  passEl.addEventListener('keydown', e => { if (e.key === 'Enter') defuse(); });

  load();
</script>
</body>
</html>
